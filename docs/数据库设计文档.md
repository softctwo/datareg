# 银行重要数据跨境数据管控系统 - 数据库设计文档

## 1. 数据库设计概述

### 1.1 设计目标

本数据库设计旨在支持银行重要数据跨境传输管控系统的核心功能，满足以下目标：

1. **合规性**：满足《数据安全法》、《个人信息保护法》等法规的审计要求
2. **完整性**：完整记录数据资产、传输场景、风险评估、审批流程等信息
3. **可追溯性**：提供完整的数据血缘关系和操作审计日志
4. **性能**：优化查询性能，支持高并发访问
5. **扩展性**：设计灵活的数据结构，支持未来业务扩展

### 1.2 设计原则

1. **规范化**：遵循数据库设计范式，避免数据冗余
2. **一致性**：确保数据引用完整性
3. **性能优化**：合理设计索引，优化查询效率
4. **安全性**：敏感数据加密存储，访问权限控制
5. **审计性**：完整记录数据变更历史

### 1.3 技术选型

- **数据库系统**：PostgreSQL 14+
- **ORM框架**：SQLAlchemy 2.0+
- **迁移工具**：Alembic 1.12+
- **字符编码**：UTF-8
- **时区**：UTC（统一使用协调世界时）

## 2. 数据库架构

### 2.1 数据库命名规范

| 元素 | 命名规范 | 示例 |
|------|----------|------|
| 数据库名 | 小写字母 + 下划线 | datareg |
| 表名 | 小写字母 + 下划线，复数形式 | users, data_assets |
| 字段名 | 小写字母 + 下划线 | user_name, created_at |
| 索引名 | idx_表名_字段名 | idx_users_username |
| 外键名 | fk_表名_字段名 | fk_data_assets_classification_id |

### 2.2 数据类型规范

| 数据类型 | 使用场景 | 说明 |
|----------|----------|------|
| INTEGER | 自增主键、ID字段 | 4字节整数 |
| BIGINT | 大数据量表的ID | 8字节整数 |
| VARCHAR(n) | 短文本字段 | 变长字符串 |
| TEXT | 长文本字段 | 不定长文本 |
| BOOLEAN | 布尔值字段 | true/false |
| TIMESTAMP WITH TIME ZONE | 时间戳字段 | 带时区的时间 |
| NUMERIC(p,s) | 精确数值 | 金融金额、评分等 |
| JSON | 结构化数据 | 复杂对象存储 |
| ENUM | 枚举类型 | 有限集合值 |

### 2.3 字段命名约定

- **主键**：统一使用 `id`
- **外键**：`{表名}_id`
- **时间戳**：`created_at`（创建时间）、`updated_at`（更新时间）
- **布尔字段**：以 `is_` 开头
- **状态字段**：`status`
- **描述字段**：`description`、`comment`

## 3. 核心表设计

### 3.1 用户权限管理

#### 3.1.1 用户表 (users)

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE,
    hashed_password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    is_superuser BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE
);

-- 索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_is_active ON users(is_active);
```

**字段说明：**
- `id`：主键，自增
- `username`：用户名，唯一
- `email`：邮箱地址，唯一
- `hashed_password`：加密后的密码
- `full_name`：用户全名
- `is_active`：是否激活
- `is_superuser`：是否超级用户
- `created_at`：创建时间
- `updated_at`：更新时间

#### 3.1.2 角色表 (roles)

```sql
CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description VARCHAR(255),
    permissions TEXT, -- JSON格式存储权限列表
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_roles_name ON roles(name);
```

**字段说明：**
- `id`：主键，自增
- `name`：角色名称，唯一
- `description`：角色描述
- `permissions`：权限列表（JSON格式）
- `created_at`：创建时间

#### 3.1.3 用户角色关联表 (user_role)

```sql
CREATE TABLE user_role (
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role_id INTEGER NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
    PRIMARY KEY (user_id, role_id)
);
```

### 3.2 数据资产分类分级

#### 3.2.1 数据资产表 (data_assets)

```sql
CREATE TABLE data_assets (
    id SERIAL PRIMARY KEY,
    asset_name VARCHAR(200) NOT NULL,
    asset_code VARCHAR(100) UNIQUE NOT NULL,
    asset_type VARCHAR(50), -- 表/视图/接口/文件
    source_system VARCHAR(100),
    schema_name VARCHAR(100),
    table_name VARCHAR(200),

    -- 分类分级信息
    data_level VARCHAR(20) NOT NULL DEFAULT '内部数据',
    classification_id INTEGER REFERENCES data_classifications(id),

    -- 元数据
    description TEXT,
    field_count INTEGER,
    record_count BIGINT,

    -- 血缘关系
    upstream_assets TEXT, -- JSON格式存储上游资产ID列表
    downstream_assets TEXT, -- JSON格式存储下游资产ID列表

    -- 状态
    is_active BOOLEAN DEFAULT TRUE,
    last_scan_time TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE
);

-- 索引
CREATE INDEX idx_data_assets_name ON data_assets(asset_name);
CREATE INDEX idx_data_assets_code ON data_assets(asset_code);
CREATE INDEX idx_data_assets_level ON data_assets(data_level);
CREATE INDEX idx_data_assets_classification ON data_assets(classification_id);
CREATE INDEX idx_data_assets_created ON data_assets(created_at);
```

**字段说明：**
- `id`：主键，自增
- `asset_name`：资产名称
- `asset_code`：资产编码，唯一
- `asset_type`：资产类型（表、视图、接口、文件）
- `source_system`：来源系统
- `schema_name`：数据库Schema
- `table_name`：表名
- `data_level`：数据安全级别（枚举：核心数据、重要数据、敏感个人信息、个人信息、内部数据、公开数据）
- `classification_id`：分类ID，外键
- `description`：描述
- `field_count`：字段数量
- `record_count`：记录数
- `upstream_assets`：上游资产（JSON）
- `downstream_assets`：下游资产（JSON）
- `is_active`：是否启用
- `last_scan_time`：最后扫描时间
- `created_at`：创建时间
- `updated_at`：更新时间

#### 3.2.2 数据分类表 (data_classifications)

```sql
CREATE TABLE data_classifications (
    id SERIAL PRIMARY KEY,
    category_name VARCHAR(100) NOT NULL,
    category_code VARCHAR(50) UNIQUE NOT NULL,
    parent_id INTEGER REFERENCES data_classifications(id),
    level INTEGER DEFAULT 1,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_data_classifications_name ON data_classifications(category_name);
CREATE INDEX idx_data_classifications_code ON data_classifications(category_code);
CREATE INDEX idx_data_classifications_parent ON data_classifications(parent_id);
```

**字段说明：**
- `id`：主键，自增
- `category_name`：分类名称
- `category_code`：分类编码，唯一
- `parent_id`：父分类ID，支持层级分类
- `level`：分类层级
- `description`：描述
- `created_at`：创建时间

#### 3.2.3 敏感标签表 (sensitive_tags)

```sql
CREATE TABLE sensitive_tags (
    id SERIAL PRIMARY KEY,
    tag_name VARCHAR(100) UNIQUE NOT NULL,
    tag_code VARCHAR(50) UNIQUE NOT NULL,
    tag_type VARCHAR(50), -- PII/重要数据/核心数据
    detection_rule TEXT, -- 识别规则（正则表达式或规则描述）
    risk_level VARCHAR(20), -- 高/中/低
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE
);

-- 索引
CREATE INDEX idx_sensitive_tags_name ON sensitive_tags(tag_name);
CREATE INDEX idx_sensitive_tags_code ON sensitive_tags(tag_code);
CREATE INDEX idx_sensitive_tags_type ON sensitive_tags(tag_type);
```

**字段说明：**
- `id`：主键，自增
- `tag_name`：标签名称，唯一
- `tag_code`：标签编码，唯一
- `tag_type`：标签类型
- `detection_rule`：识别规则
- `risk_level`：风险等级
- `description`：描述
- `is_active`：是否启用
- `created_at`：创建时间
- `updated_at`：更新时间

#### 3.2.4 资产标签关联表 (asset_tag_association)

```sql
CREATE TABLE asset_tag_association (
    asset_id INTEGER NOT NULL REFERENCES data_assets(id) ON DELETE CASCADE,
    tag_id INTEGER NOT NULL REFERENCES sensitive_tags(id) ON DELETE CASCADE,
    PRIMARY KEY (asset_id, tag_id)
);
```

### 3.3 跨境传输场景管理

#### 3.3.1 跨境场景表 (cross_border_scenarios)

```sql
CREATE TABLE cross_border_scenarios (
    id SERIAL PRIMARY KEY,
    scenario_name VARCHAR(200) NOT NULL,
    scenario_code VARCHAR(100) UNIQUE NOT NULL,
    business_type VARCHAR(100), -- 审计/合规审查/报表汇总/其他

    -- 境外接收方信息
    recipient_name VARCHAR(200) NOT NULL,
    recipient_country VARCHAR(100) NOT NULL,
    recipient_type VARCHAR(50), -- 母行/境外分行/第三方机构

    -- 传输要素
    data_purpose TEXT NOT NULL,
    storage_duration INTEGER, -- 存储期限（天）
    transfer_frequency VARCHAR(50), -- 实时/日/周/月/一次性
    security_level VARCHAR(50), -- 高/中/低
    encryption_method VARCHAR(100),

    -- 数据范围
    data_scope TEXT,
    estimated_volume NUMERIC(20,0),

    -- 状态和审批
    status VARCHAR(20) DEFAULT '草稿',
    approver_id INTEGER REFERENCES users(id),
    approved_at TIMESTAMP WITH TIME ZONE,
    expiry_date TIMESTAMP WITH TIME ZONE,

    -- 元数据
    description TEXT,
    created_by INTEGER NOT NULL REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE
);

-- 索引
CREATE INDEX idx_scenarios_name ON cross_border_scenarios(scenario_name);
CREATE INDEX idx_scenarios_status ON cross_border_scenarios(status);
CREATE INDEX idx_scenarios_country ON cross_border_scenarios(recipient_country);
CREATE INDEX idx_scenarios_created_by ON cross_border_scenarios(created_by);
CREATE INDEX idx_scenarios_expiry ON cross_border_scenarios(expiry_date);
```

**字段说明：**
- `id`：主键，自增
- `scenario_name`：场景名称
- `scenario_code`：场景编码，唯一
- `business_type`：业务类型
- `recipient_name`：接收方名称
- `recipient_country`：接收方所在国
- `recipient_type`：接收方类型
- `data_purpose`：数据用途
- `storage_duration`：存储期限（天）
- `transfer_frequency`：传输频率
- `security_level`：链路安全级别
- `encryption_method`：加密方式
- `data_scope`：数据范围描述
- `estimated_volume`：预估数据量
- `status`：场景状态（枚举：草稿、待审批、已批准、已拒绝、已过期、已暂停）
- `approver_id`：审批人ID
- `approved_at`：批准时间
- `expiry_date`：到期日期
- `description`：描述
- `created_by`：创建人ID
- `created_at`：创建时间
- `updated_at`：更新时间

#### 3.3.2 传输审批表 (transfer_approvals)

```sql
CREATE TABLE transfer_approvals (
    id SERIAL PRIMARY KEY,
    scenario_id INTEGER NOT NULL REFERENCES cross_border_scenarios(id),

    -- 审批信息
    approval_status VARCHAR(20) DEFAULT '待审批',
    applicant_id INTEGER NOT NULL REFERENCES users(id),
    approver_id INTEGER REFERENCES users(id),

    -- 传输详情
    transfer_type VARCHAR(50), -- API/文件/数据库
    data_assets TEXT, -- JSON数组存储涉及的数据资产ID
    transfer_start_time TIMESTAMP WITH TIME ZONE,
    transfer_end_time TIMESTAMP WITH TIME ZONE,
    actual_volume NUMERIC(20,0),

    -- 审批意见
    approval_comment TEXT,
    approved_at TIMESTAMP WITH TIME ZONE,
    rejected_reason TEXT,

    -- 元数据
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE
);

-- 索引
CREATE INDEX idx_approvals_scenario ON transfer_approvals(scenario_id);
CREATE INDEX idx_approvals_status ON transfer_approvals(approval_status);
CREATE INDEX idx_approvals_applicant ON transfer_approvals(applicant_id);
CREATE INDEX idx_approvals_created ON transfer_approvals(created_at);
```

### 3.4 风险评估管理

#### 3.4.1 风险评估表 (risk_assessments)

```sql
CREATE TABLE risk_assessments (
    id SERIAL PRIMARY KEY,
    assessment_name VARCHAR(200) NOT NULL,
    assessment_code VARCHAR(100) UNIQUE NOT NULL,
    assessment_type VARCHAR(50) DEFAULT 'PIA', -- PIA/DPIA

    -- 关联场景
    scenario_id INTEGER NOT NULL REFERENCES cross_border_scenarios(id),

    -- 评估维度（0-100分）
    legal_environment_score NUMERIC(5,2), -- 境外接收方所在国法律环境评分
    data_volume_score NUMERIC(5,2), -- 数据规模评分
    security_measures_score NUMERIC(5,2), -- 安全措施评分
    data_sensitivity_score NUMERIC(5,2), -- 数据敏感性评分

    -- 阈值检查
    personal_info_count NUMERIC(20,0) DEFAULT 0, -- 个人信息数量
    sensitive_info_count NUMERIC(20,0) DEFAULT 0, -- 敏感个人信息数量
    exceeds_personal_threshold BOOLEAN DEFAULT FALSE, -- 是否超过个人信息阈值
    exceeds_sensitive_threshold BOOLEAN DEFAULT FALSE, -- 是否超过敏感信息阈值

    -- 综合评估
    overall_risk_level VARCHAR(20), -- 低/中/高/极高
    overall_score NUMERIC(5,2), -- 综合评分（0-100）
    risk_factors JSON, -- 风险因素（JSON）
    mitigation_measures TEXT, -- 缓解措施

    -- 评估结果
    assessment_result TEXT, -- 评估结论
    requires_regulatory_approval BOOLEAN DEFAULT FALSE, -- 是否需要监管审批
    recommendation TEXT, -- 建议

    -- 状态
    status VARCHAR(20) DEFAULT '草稿',
    assessor_id INTEGER REFERENCES users(id),
    reviewed_by INTEGER REFERENCES users(id),

    -- 元数据
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE
);

-- 索引
CREATE INDEX idx_risk_assessments_scenario ON risk_assessments(scenario_id);
CREATE INDEX idx_risk_assessments_status ON risk_assessments(status);
CREATE INDEX idx_risk_assessments_risk_level ON risk_assessments(overall_risk_level);
```

### 3.5 审计日志管理

#### 3.5.1 审计日志表 (audit_logs)

```sql
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,

    -- 操作信息
    action VARCHAR(20) NOT NULL, -- 操作类型
    resource_type VARCHAR(50), -- 资源类型：数据资产/场景/审批/评估
    resource_id INTEGER, -- 资源ID

    -- 用户信息
    user_id INTEGER NOT NULL REFERENCES users(id),
    username VARCHAR(50), -- 用户名（冗余字段，便于查询）
    ip_address VARCHAR(50),
    user_agent VARCHAR(500),

    -- 操作详情
    operation_details JSON, -- 操作详情（JSON）
    before_data JSON, -- 操作前数据（JSON）
    after_data JSON, -- 操作后数据（JSON）

    -- 传输相关
    transfer_volume NUMERIC(20,0), -- 传输数据量
    destination_country VARCHAR(100), -- 目的国
    transfer_status VARCHAR(50), -- 传输状态：成功/失败/拦截

    -- 异常标记
    is_anomaly BOOLEAN DEFAULT FALSE,
    anomaly_type VARCHAR(50),
    anomaly_reason TEXT,

    -- 时间戳
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_audit_logs_user ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_timestamp ON audit_logs(created_at);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);
CREATE INDEX idx_audit_logs_anomaly ON audit_logs(is_anomaly);
```

### 3.6 数据导出管理

#### 3.6.1 导出记录表 (export_records)

```sql
CREATE TABLE export_records (
    id SERIAL PRIMARY KEY,
    export_name VARCHAR(200) NOT NULL,
    export_type VARCHAR(50) NOT NULL, -- CSV/JSON/PDF
    module VARCHAR(50) NOT NULL, -- 数据资产/场景/审批/审计

    -- 导出参数
    export_params JSON, -- 导出参数（JSON）
    file_path VARCHAR(500), -- 文件路径
    file_size BIGINT, -- 文件大小（字节）

    -- 执行信息
    status VARCHAR(20) DEFAULT '处理中', -- 处理中/已完成/失败
    error_message TEXT,
    record_count INTEGER, -- 导出记录数

    -- 用户信息
    user_id INTEGER NOT NULL REFERENCES users(id),

    -- 时间戳
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP WITH TIME ZONE
);

-- 索引
CREATE INDEX idx_export_records_user ON export_records(user_id);
CREATE INDEX idx_export_records_module ON export_records(module);
CREATE INDEX idx_export_records_status ON export_records(status);
```

## 4. 视图设计

### 4.1 数据资产统计视图

```sql
CREATE VIEW v_asset_statistics AS
SELECT
    dc.category_name,
    da.data_level,
    COUNT(*) as asset_count,
    SUM(da.record_count) as total_records
FROM data_assets da
LEFT JOIN data_classifications dc ON da.classification_id = dc.id
WHERE da.is_active = TRUE
GROUP BY dc.category_name, da.data_level;
```

### 4.2 场景状态统计视图

```sql
CREATE VIEW v_scenario_status_stats AS
SELECT
    status,
    COUNT(*) as scenario_count,
    COUNT(CASE WHEN expiry_date > CURRENT_TIMESTAMP THEN 1 END) as active_count,
    recipient_country
FROM cross_border_scenarios
GROUP BY status, recipient_country;
```

### 4.3 审计日志统计视图

```sql
CREATE VIEW v_audit_statistics AS
SELECT
    DATE_TRUNC('day', created_at) as date,
    action,
    resource_type,
    COUNT(*) as action_count,
    COUNT(CASE WHEN is_anomaly = TRUE THEN 1 END) as anomaly_count
FROM audit_logs
WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY DATE_TRUNC('day', created_at), action, resource_type;
```

## 5. 索引设计

### 5.1 主要索引列表

```sql
-- 用户表索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_is_active ON users(is_active);

-- 数据资产表索引
CREATE INDEX idx_data_assets_name ON data_assets(asset_name);
CREATE INDEX idx_data_assets_code ON data_assets(asset_code);
CREATE INDEX idx_data_assets_level ON data_assets(data_level);
CREATE INDEX idx_data_assets_classification ON data_assets(classification_id);
CREATE INDEX idx_data_assets_created ON data_assets(created_at);
CREATE INDEX idx_data_assets_active ON data_assets(is_active) WHERE is_active = TRUE;

-- 场景表索引
CREATE INDEX idx_scenarios_name ON cross_border_scenarios(scenario_name);
CREATE INDEX idx_scenarios_status ON cross_border_scenarios(status);
CREATE INDEX idx_scenarios_country ON cross_border_scenarios(recipient_country);
CREATE INDEX idx_scenarios_created_by ON cross_border_scenarios(created_by);
CREATE INDEX idx_scenarios_expiry ON cross_border_scenarios(expiry_date);
CREATE INDEX idx_scenarios_status_expiry ON cross_border_scenarios(status, expiry_date);

-- 审批表索引
CREATE INDEX idx_approvals_scenario ON transfer_approvals(scenario_id);
CREATE INDEX idx_approvals_status ON transfer_approvals(approval_status);
CREATE INDEX idx_approvals_applicant ON transfer_approvals(applicant_id);
CREATE INDEX idx_approvals_created ON transfer_approvals(created_at);

-- 风险评估表索引
CREATE INDEX idx_risk_assessments_scenario ON risk_assessments(scenario_id);
CREATE INDEX idx_risk_assessments_status ON risk_assessments(status);
CREATE INDEX idx_risk_assessments_risk_level ON risk_assessments(overall_risk_level);
CREATE INDEX idx_risk_assessments_score ON risk_assessments(overall_score);

-- 审计日志表索引
CREATE INDEX idx_audit_logs_user ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_timestamp ON audit_logs(created_at);
CREATE INDEX idx_audit_logs_resource ON audit_logs(resource_type, resource_id);
CREATE INDEX idx_audit_logs_anomaly ON audit_logs(is_anomaly) WHERE is_anomaly = TRUE;

-- 复合索引
CREATE INDEX idx_data_assets_level_classification ON data_assets(data_level, classification_id);
CREATE INDEX idx_audit_logs_user_timestamp ON audit_logs(user_id, created_at);
CREATE INDEX idx_scenarios_status_created ON cross_border_scenarios(status, created_at);
```

### 5.2 索引使用建议

1. **主键索引**：所有表都有主键索引
2. **外键索引**：所有外键字段都创建索引
3. **查询索引**：根据常用查询条件创建索引
4. **复合索引**：多字段组合查询创建复合索引
5. **部分索引**：针对特定条件创建部分索引

## 6. 数据字典

### 6.1 枚举值定义

#### 6.1.1 数据安全级别 (DataLevel)

| 值 | 说明 | 风险等级 | 处理要求 |
|----|-----|----------|----------|
| 核心数据 | 涉及国家安全的数据 | 极高 | 严禁出境 |
| 重要数据 | 重要行业和领域数据 | 高 | 严格管控 |
| 敏感个人信息 | 生物识别、宗教信仰等 | 高 | 必须脱敏 |
| 个人信息 | 一般个人信息 | 中 | 需要授权 |
| 内部数据 | 企业内部数据 | 低 | 内部使用 |
| 公开数据 | 已公开数据 | 极低 | 可以公开 |

#### 6.1.2 场景状态 (ScenarioStatus)

| 值 | 说明 | 可操作 |
|----|-----|----------|
| 草稿 | 场景创建中 | 编辑、删除、提交 |
| 待审批 | 已提交审批 | 撤回 |
| 已批准 | 审批通过 | 使用、暂停 |
| 已拒绝 | 审批拒绝 | 修改后重新提交 |
| 已过期 | 已超过有效期 | 重新申请 |
| 已暂停 | 暂时停止使用 | 恢复 |

#### 6.1.3 审批状态 (ApprovalStatus)

| 值 | 说明 | 说明 |
|----|-----|------|
| 待审批 | 等待审批人处理 | - |
| 已批准 | 审批人批准传输 | 可以传输 |
| 已拒绝 | 审批人拒绝传输 | 不能传输 |
| 已取消 | 申请人取消申请 | - |

#### 6.1.4 风险等级 (RiskLevel)

| 值 | 评分范围 | 说明 |
|----|----------|------|
| 极高风险 | 0-39 | 严重风险，不建议出境 |
| 高风险 | 40-59 | 高风险，需要加强措施 |
| 中风险 | 60-79 | 中等风险，需要基本措施 |
| 低风险 | 80-100 | 低风险，可以正常传输 |

#### 6.1.5 审计操作类型 (AuditAction)

| 值 | 说明 | 关联资源 |
|----|-----|----------|
| 创建 | 创建记录 | 数据资产、场景、评估 |
| 更新 | 更新记录 | 所有资源 |
| 删除 | 删除记录 | 所有资源 |
| 审批 | 审批操作 | 场景、传输 |
| 拒绝 | 拒绝操作 | 场景、传输 |
| 传输 | 数据传输 | 传输记录 |
| 拦截 | 拦截传输 | 传输记录 |
| 脱敏 | 数据脱敏 | 数据资产 |
| 查看 | 查看记录 | 所有资源 |
| 导出 | 数据导出 | 所有资源 |

### 6.2 权限定义

#### 6.2.1 功能权限

| 权限代码 | 权限名称 | 说明 |
|----------|----------|------|
| asset:view | 查看数据资产 | 浏览数据资产列表和详情 |
| asset:create | 创建数据资产 | 新建数据资产记录 |
| asset:update | 更新数据资产 | 修改数据资产信息 |
| asset:delete | 删除数据资产 | 删除数据资产 |
| asset:scan | 扫描数据资产 | 扫描数据库发现资产 |
| scenario:view | 查看跨境场景 | 浏览场景列表和详情 |
| scenario:create | 创建跨境场景 | 新建跨境传输场景 |
| scenario:update | 更新跨境场景 | 修改场景信息 |
| scenario:delete | 删除跨境场景 | 删除场景 |
| scenario:submit | 提交场景审批 | 将场景提交审批 |
| scenario:approve | 审批场景 | 批准或拒绝场景 |
| approval:view | 查看传输审批 | 浏览审批列表和详情 |
| approval:create | 创建传输审批 | 新建传输审批申请 |
| approval:process | 处理传输审批 | 批准或拒绝传输 |
| risk:view | 查看风险评估 | 浏览评估列表和详情 |
| risk:create | 创建风险评估 | 新建风险评估 |
| risk:update | 更新风险评估 | 修改评估内容 |
| risk:calculate | 计算风险 | 执行风险计算 |
| audit:view | 查看审计日志 | 浏览审计日志 |
| audit:export | 导出审计数据 | 导出审计记录 |
| user:view | 查看用户 | 浏览用户列表 |
| user:create | 创建用户 | 新建用户账号 |
| user:update | 更新用户 | 修改用户信息 |
| user:delete | 删除用户 | 删除用户账号 |
| role:view | 查看角色 | 浏览角色列表 |
| role:create | 创建角色 | 新建角色 |
| role:update | 更新角色 | 修改角色权限 |
| role:delete | 删除角色 | 删除角色 |
| system:monitor | 系统监控 | 查看监控仪表盘 |
| system:config | 系统配置 | 修改系统配置 |

#### 6.2.2 数据权限

| 权限类型 | 说明 | 示例 |
|----------|------|------|
| 全部数据 | 可以查看所有数据 | 系统管理员 |
| 本部门数据 | 只能查看本部门数据 | 部门管理员 |
| 个人数据 | 只能查看自己创建的数据 | 普通用户 |
| 指定数据 | 按指定条件过滤数据 | 特定角色 |

## 7. 数据生命周期管理

### 7.1 数据保留策略

| 数据类型 | 保留期限 | 说明 |
|----------|----------|------|
| 审计日志 | 3年 | 法律要求保留3年 |
| 用户登录日志 | 1年 | 安全监控需要 |
| 传输记录 | 5年 | 合规审计需要 |
| 评估报告 | 永久 | 重要合规文档 |
| 系统日志 | 6个月 | 系统维护需要 |

### 7.2 数据备份策略

```sql
-- 创建备份表
CREATE TABLE audit_logs_backup (LIKE audit_logs);

-- 分区表设计（按月分区）
CREATE TABLE audit_logs_y2024m01 PARTITION OF audit_logs
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- 数据清理
DELETE FROM audit_logs
WHERE created_at < CURRENT_DATE - INTERVAL '3 years';
```

## 8. 性能优化

### 8.1 查询优化

#### 8.1.1 分页查询优化

```sql
-- 使用游标分页（避免OFFSET性能问题）
SELECT * FROM data_assets
WHERE id > last_id
ORDER BY id
LIMIT 20;

-- 使用索引提示
SELECT * FROM data_assets USE INDEX(idx_data_assets_level)
WHERE data_level = '重要数据';
```

#### 8.1.2 统计查询优化

```sql
-- 使用物化视图
CREATE MATERIALIZED VIEW mv_asset_stats AS
SELECT
    data_level,
    COUNT(*) as count,
    SUM(record_count) as total_records
FROM data_assets
WHERE is_active = TRUE
GROUP BY data_level;

-- 定期刷新物化视图
REFRESH MATERIALIZED VIEW mv_asset_stats;
```

### 8.2 存储优化

#### 8.2.1 表分区

```sql
-- 审计日志按月分区
CREATE TABLE audit_logs (
    -- 字段定义
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
) PARTITION BY RANGE (created_at);

-- 创建分区
CREATE TABLE audit_logs_2024_01 PARTITION OF audit_logs
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

#### 8.2.2 数据压缩

```sql
-- 启用表压缩
ALTER TABLE audit_logs SET (toast_tuple_target = 128);
ALTER TABLE audit_logs SET (fillfactor = 90);
```

## 9. 安全设计

### 9.1 敏感数据加密

```sql
-- 创建加密函数
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 敏感字段加密存储
ALTER TABLE users
ADD COLUMN encrypted_email TEXT;

-- 加密存储
UPDATE users
SET encrypted_email = pgp_sym_encrypt(email, 'encryption_key')
WHERE email IS NOT NULL;
```

### 9.2 行级安全

```sql
-- 启用行级安全
ALTER TABLE data_assets ENABLE ROW LEVEL SECURITY;

-- 创建安全策略
CREATE POLICY user_own_assets_policy ON data_assets
FOR ALL TO application_user
USING (created_by = current_setting('app.current_user_id')::integer);
```

## 10. 监控和维护

### 10.1 性能监控

```sql
-- 慢查询监控
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
WHERE mean_time > 1000
ORDER BY mean_time DESC;

-- 索引使用情况
SELECT schemaname, tablename, indexname, idx_scan, idx_tup_read, idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

### 10.2 数据完整性检查

```sql
-- 检查外键完整性
SELECT conname, conrelid::regclass, confrelid::regclass
FROM pg_constraint
WHERE contype = 'f'
AND NOT EXISTS (
    SELECT 1 FROM pg_inherits
    WHERE inhrelid = conrelid
    OR inhrelid = confrelid
);

-- 检查数据一致性
SELECT 'data_assets' as table_name,
       COUNT(*) as total_rows,
       COUNT(CASE WHEN classification_id IS NULL THEN 1 END) as null_classifications
FROM data_assets;
```

## 11. 数据库迁移

### 11.1 版本控制

使用Alembic进行数据库版本控制：

```python
# alembic/versions/001_initial_schema.py
def upgrade():
    # 创建表
    op.create_table('users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('username', sa.String(length=50), nullable=False),
        # ... 其他字段
    )

def downgrade():
    # 删除表
    op.drop_table('users')
```

### 11.2 数据迁移脚本

```sql
-- 数据迁移示例
-- 迁移旧数据到新表结构
INSERT INTO data_assets_new (
    asset_name,
    asset_code,
    data_level,
    created_at
)
SELECT
    name,
    code,
    CASE
        WHEN sensitivity = 'high' THEN '重要数据'
        WHEN sensitivity = 'medium' THEN '敏感个人信息'
        ELSE '内部数据'
    END,
    create_time
FROM data_assets_old;
```

---

**文档版本**: 1.0
**最后更新**: 2024年12月23日
**编写人**: 张彦龙